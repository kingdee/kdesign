<!DOCTYPE html>
<html>
  <head>
    <title>Demo</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: none;
      }
      {{ style }}
    </style>
    <script>
      // sync parent style generated by style-loader into iframe
      if (parent.location.port) {
        [].forEach.call(
          parent.document
            .getElementsByTagName("head")[0]
            .querySelectorAll("style"),
          function (node) {
            document
              .getElementsByTagName("head")[0]
              .appendChild(node.cloneNode(true));
          }
        );
      } else {
        // append parent stylesheet
        [].forEach.call(
          parent.document.querySelectorAll("link[rel=stylesheet]"),
          function (node) {
            node &&
              document
                .getElementsByTagName("head")[0]
                .appendChild(node.cloneNode(true));
          }
        );
      }
    </script>
  </head>
  <body>
    <div id="{{ id }}"></div>
    <script>
      function require(module) {
        if (module === "react-router") {
          return window.ReactRouter;
        }
        if (module === "react-router-dom") {
          return window.ReactRouterDOM;
        }
        return window.parent[module];
      }
      var mountNode = document.getElementById("{{ id }}");
      var React = require("react");
      var ReactDOM = require("react-dom");
    </script>
    {% if reactRouter %}
    <script src="https://unpkg.com/{{ reactRouter }}.min.js"></script>
    {% endif %}
    <script>

      var app = window.parent.IFRAME_CODES[location.pathname.substring(1)];
      var getComponent = new Function('require', `return ${app}`)(require)
      var Component = getComponent()

      // getComponent
      if ({{ injectProvider }}) {
        var container = null;
        Component = React.createElement(
          require('kdesign').ConfigProvider,
          {
            getPopupContainer() { return container; },
          },
          [
            React.cloneElement(Component, { key: 'AppContent' }),
            React.createElement('div', {
              key: 'InjectProviderHolder',
              ref(node) { container = node; },
            }),
          ],
        );
      }

      ReactDOM.render(Component, mountNode);
    </script>
  </body>
</html>
